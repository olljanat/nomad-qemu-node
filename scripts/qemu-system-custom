#!/bin/bash
set -euo pipefail

# Wrapper script for "qemu-system-x86_64" which will automatically:
# * Create TAP interface with unique MAC address.
# * Connect TAP interface to VLAN and make sure that "bond0" has access to it too.
# * Mount "config-drive" to VM if provided.
# * Configure QEMU listening VNC in Unix socket.
# * Download image from URL (global cache, ETag-based updates) and create linked clone.

CHILD=""
BOOT_TYPE="SECURE_BOOT"
EXTRA_ARGS=()
IMAGE_URL=""
IMAGES_DIR="/data/images"
VGA_DEVICE="VGA"
VLAN=""

# Functions
cleanup() {
  status=$?
  echo "qemu-system-custom: Cleanup process called with status: $status" >&2
  if [[ -n "$CHILD" ]]; then
    if ps -p "$CHILD" > /dev/null; then
      echo "qemu-system-custom: Sending SIGINT to PID $CHILD (qemu-system-x86_64)" >&2
      kill -2 "$CHILD"
      sleep 5s
      if ps -p "$CHILD" > /dev/null; then
        echo "qemu-system-custom: PID $CHILD is still running. Sending SIGKILL" >&2
        kill -9 "$CHILD"
        sleep 10s
      fi
    fi
  fi
  echo "qemu-system-custom: Removing TAP interface $TAP_IF" >&2
  ip tuntap del dev "$TAP_IF" mode tap

  # Remove parent image only if none of the jobs is referencing it and it is not latest.
  if [[ -f "$JOB_DIR/diff.$NOMAD_ALLOC_ID.parent" ]]; then
    PARENT_FILE=$(cat "$JOB_DIR/diff.$NOMAD_ALLOC_ID.parent")
    echo "qemu-system-custom: Removing differential image $JOB_DIR/diff.$NOMAD_ALLOC_ID.qcow2 (backed by $PARENT_FILE)" >&2
    rm -f "$JOB_DIR/diff.$NOMAD_ALLOC_ID.qcow2" "$JOB_DIR/diff.$NOMAD_ALLOC_ID.parent"

    REFCOUNT_FILE="${PARENT_FILE}.refcount"
    REF_LOCK="${PARENT_FILE}.ref.lock"
    (
      flock -x 202
      if [[ -f "$REFCOUNT_FILE" ]]; then
        COUNT=$(cat "$REFCOUNT_FILE")
        if [[ $COUNT -gt 1 ]]; then
          echo $((COUNT - 1)) > "$REFCOUNT_FILE"
        else
          rm -f "$REFCOUNT_FILE"
          # Delete only if NOT the current latest
          IMAGE_DIR=$(dirname "$PARENT_FILE")
          if [[ -f "$IMAGE_DIR/current_version.txt" ]]; then
            LATEST_BASENAME=$(cat "$IMAGE_DIR/current_version.txt")
            LATEST_FILE="$IMAGE_DIR/$LATEST_BASENAME"
            if [[ "$PARENT_FILE" != "$LATEST_FILE" ]]; then
              echo "qemu-system-custom: Removing unused old parent $PARENT_FILE" >&2
              rm -f "$PARENT_FILE"
            else
              echo "qemu-system-custom: Keeping latest parent $PARENT_FILE (no active diffs)" >&2
            fi
          else
            rm -f "$PARENT_FILE"
          fi
        fi
      fi
    ) 202>"$REF_LOCK"
  else
    rm -f "$JOB_DIR/diff.$NOMAD_ALLOC_ID.qcow2"
  fi
  rm -f "/tmp/vnc/${VM_NAME}.sock"
  if [ -v NOMAD_HOST_PORT_qemu_guest_agent ]; then
    iptables -t nat -D OUTPUT -p tcp --dport $NOMAD_HOST_PORT_qemu_guest_agent -j REDIRECT --to-ports 5801
  fi
}
generate_mac() {
  local bytes
  bytes=$(hexdump -n3 -v -e '3/1 "%02X"' /dev/urandom)
  printf "52:54:00:%s:%s:%s" "${bytes:0:2}" "${bytes:2:2}" "${bytes:4:2}"
}
is_valid_url() {
  # Accept common URI schemes: letters followed by letters/digits/+.- then ://
  # Basic host/path check; allows query/fragments/spaces only if quoted upstream.
  local url="$1"

  # Trim leading/trailing whitespace just in case
  url="${url#"${url%%[![:space:]]*}"}"
  url="${url%"${url##*[![:space:]]}"}"

  # Regex:
  #  scheme://host[/...]
  #  scheme must start with letter, then [A-Za-z0-9+.-]
  #  host can't start with / or whitespace
  # NOTE: This is pragmatic, not RFC-perfect. Tight enough to catch obvious errors.
  local re='^[A-Za-z][A-Za-z0-9+.\-]*://[^/[:space:]][^[:space:]]*$'

  if [[ "$url" =~ $re ]]; then
    return 0
  else
    return 1
  fi
}
usage() {
  echo "Usage: $0 -vlan VID [QEMU_ARGS...]" >&2
  echo "Example: $0 -vlan 100 -m 4096 -drive file=disk.qcow2,if=virtio" >&2
}

if [ $# -eq 0 ]; then
  usage
  exit
fi
while [[ $# -gt 0 ]]; do
  case "$1" in
    -boot-type)
      BOOT_TYPE="$2"
      shift 2
      ;;
    -drive)
      # The entire -drive value is the next token
      drv="${2:-}"

      # Parse comma-separated key=value pairs in the -drive argument
      # NOTE: This simple parser splits by commas, so file values containing commas
      # must be quoted and the parsing logic would need an upgrade to handle them.
      id_val=""
      file_val=""

      IFS=',' read -ra kvpairs <<< "$drv"
      for kv in "${kvpairs[@]}"; do
        key="${kv%%=*}"
        val="${kv#*=}"

        # Strip surrounding quotes from val (supports "val" or 'val')
        if [[ "$val" == \"*\" && "$val" == *\" ]]; then
          val="${val%\"}"
          val="${val#\"}"
        elif [[ "$val" == \'*\' && "$val" == *\' ]]; then
          val="${val%\'}"
          val="${val#\'}"
        fi

        case "$key" in
          id)   id_val="$val" ;;
          file) file_val="$val" ;;
        esac
      done

      if [[ "$id_val" == "image0" ]]; then
        # Require file to be a URL
        if [[ -z "$file_val" ]]; then
          echo "Error: -drive with id=image0 must include a 'file=' URL." >&2
          exit 1
        fi
        if ! is_valid_url "$file_val"; then
          echo "Error: 'file' for id=image0 is not a valid URL: $file_val" >&2
          echo "       Expected format like: https://host/path or s3://bucket/key" >&2
          exit 1
        fi

        IMAGE_URL="$file_val"
        # Do NOT pass this drive to QEMU; you handle the URL in the wrapper.
      else
        # Pass other drives as-is
        EXTRA_ARGS+=("-drive" "$drv")
      fi

      shift 2
      ;;
    -name)
      VM_NAME="${NOMAD_JOB_NAME}-${NOMAD_GROUP_NAME}-${NOMAD_ALLOC_INDEX}"
      shift 2
      ;;
    -machine)
      shift 2
      ;;
    -m)
      VM_MEM=$((${2/M/} - 1024))
      MAX_MEM=$(cat /proc/meminfo | grep -i 'memtotal' | grep -o '[[:digit:]]*')
      EXTRA_ARGS+=("-m" "size=${VM_MEM}M,slots=256,maxmem=${MAX_MEM}k")
      shift 2
      ;;
    -smp)
      CPU_COUNT="$2"
      HOST_CPU_COUNT=$(nproc --all)
      EXTRA_ARGS+=("-smp" "${2},maxcpus=${HOST_CPU_COUNT}")
      shift 2
      ;;
    --version)
      VLAN="unknown"
      /usr/bin/qemu-system-x86_64 -version
      exit 0
      ;;
    -vga-device)
      VGA_DEVICE="$2"
      shift 2
      ;;
    -vlan)
      VLAN="$2"
      shift 2
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      EXTRA_ARGS+=("$1")
      shift
      ;;
  esac
done
if [[ -z "$VLAN" ]]; then
  echo "qemu-system-custom: Parameter -vlan is mandantory" >&2
  exit
fi
TASK_DIR="/data/nomad/alloc/$NOMAD_ALLOC_ID/$NOMAD_TASK_NAME"
case $BOOT_TYPE in
  SECURE_BOOT)    BOOT_TYPE_ARGS=("-drive" "if=pflash,format=raw,readonly=on,file=/usr/share/OVMF/OVMF_CODE_4M.secboot.fd" "-drive" "if=pflash,format=raw,file=${TASK_DIR}/OVMF_VARS_4M.ms.fd") ;;
  UEFI)           BOOT_TYPE_ARGS=("-bios" "/usr/share/ovmf/OVMF.fd") ;;
  BIOS)           BOOT_TYPE_ARGS=() ;;
  *)              echo "qemu-system-custom: -boot-type $BOOT_TYPE is not supported" >&2; exit ;;
esac
JOB_DIR="/data/jobs/$NOMAD_JOB_NAME"
mkdir -p "$JOB_DIR"

# === Global image handling with ETag-based updates ===
IMAGE_BASENAME=$(basename "$IMAGE_URL")
IMAGE_NAME=$(echo "$IMAGE_BASENAME" | sed 's/[^a-zA-Z0-9._-]/_/g')
IMAGE_DIR="$IMAGES_DIR/$IMAGE_NAME"
mkdir -p "$IMAGE_DIR"
LOCK_FILE="$IMAGE_DIR/.lock"

sleep $((${NOMAD_ALLOC_INDEX}*3))s
(
  flock -x 200 || { echo "qemu-system-custom: Waiting for image lock on $IMAGE_NAME..." >&2; flock -x 200; }

  REMOTE_ETAG=$(curl -sI "$IMAGE_URL" | grep -i '^ETag:' | head -n1 | awk '{print $2}' | tr -d '\r')
  [[ -z "$REMOTE_ETAG" ]] && REMOTE_ETAG="no-etag-$(date +%s)"

  CURRENT_ETAG=$(cat "$IMAGE_DIR/current.etag" 2>/dev/null || echo "")

  if [[ "$REMOTE_ETAG" != "$CURRENT_ETAG" ]] || [[ ! -f "$IMAGE_DIR/current_version.txt" ]]; then
    echo "qemu-system-custom: New version detected for $IMAGE_NAME (ETag changed). Downloading..." >&2

    TEMP_FILE=$(mktemp "$IMAGE_DIR/download.XXXXXX")
    curl -L -f -o "$TEMP_FILE" "$IMAGE_URL"

    ETAG_CLEAN=$(echo "$REMOTE_ETAG" | sed 's/"//g' | tr '[:upper:]' '[:lower:]' | tr -c 'a-z0-9._-' '_')
    VERSION_BASENAME="${IMAGE_NAME}-${ETAG_CLEAN}.qcow2"
    VERSION_FILE="$IMAGE_DIR/$VERSION_BASENAME"

    echo "qemu-system-custom: Converting to qcow2..." >&2
    qemu-img convert -q -O qcow2 "$TEMP_FILE" "$VERSION_FILE"

    rm -f "$TEMP_FILE"
    echo "$REMOTE_ETAG" > "$IMAGE_DIR/current.etag"
    echo "$VERSION_BASENAME" > "$IMAGE_DIR/current_version.txt"
    ln -sf "$VERSION_FILE" "$IMAGE_DIR/latest.qcow2"  # optional, for inspection
  fi
) 200>"$LOCK_FILE"

CURRENT_VERSION=$(cat "$IMAGE_DIR/current_version.txt")
PARENT_FILE="$IMAGE_DIR/$CURRENT_VERSION"

# === Create differential image ===
echo "qemu-system-custom: Creating differential image $JOB_DIR/diff.$NOMAD_ALLOC_ID.qcow2 backed by $PARENT_FILE" >&2
qemu-img create -q -f qcow2 -F qcow2 -b "$PARENT_FILE" "$JOB_DIR/diff.$NOMAD_ALLOC_ID.qcow2"

# Record parent for cleanup/refcount
echo "$PARENT_FILE" > "$JOB_DIR/diff.$NOMAD_ALLOC_ID.parent"

# Increment refcount
REFCOUNT_FILE="${PARENT_FILE}.refcount"
REF_LOCK="${PARENT_FILE}.ref.lock"
(
  flock -x 201
  COUNT=$(cat "$REFCOUNT_FILE" 2>/dev/null || echo 0)
  echo $((COUNT + 1)) > "$REFCOUNT_FILE"
) 201>"$REF_LOCK"

# Generate MAC address (QEMU OUI prefix)
MAC_ADDR="$(generate_mac)"

# Generate TAP interface name
RANDHEX="$(hexdump -n3 -v -e '3/1 "%02x"' /dev/urandom)"
TAP_IF="tap-${RANDHEX}"

# Handle cleanup after exit
trap 'cleanup' 0

# Make sure that bond0 has access to VLAN
bridge vlan add dev bond0 vid "$VLAN" master

# Create TAP interface
echo "qemu-system-custom: Creating TAP interface $TAP_IF with MAC address $MAC_ADDR" >&2
ip tuntap add dev "$TAP_IF" mode tap
ip link set "$TAP_IF" master br0
ip link set "$TAP_IF" up
bridge vlan del dev "$TAP_IF" vid 1
bridge vlan add dev "$TAP_IF" vid "$VLAN" pvid untagged

# Setup port mapping for QEMU Guest Agent proxy service
if [ -v NOMAD_HOST_PORT_qemu_guest_agent ]; then
  iptables -t nat -A OUTPUT -p tcp --dport $NOMAD_HOST_PORT_qemu_guest_agent -j REDIRECT --to-ports 5801
fi

# Prepare secure boot files
mkdir -p "$TASK_DIR"
cp "/usr/share/OVMF/OVMF_VARS_4M.ms.fd" "$TASK_DIR/"

# Add default arguments for QEMU
mkdir -p /tmp/vnc
QEMU_DEFAULT_ARGS=(
  "-name" "$VM_NAME"
  "-cpu" "host,hv-passthrough=on"
  "-machine" "type=q35,accel=kvm,usb=off,smm=on,dump-guest-core=off,mem-merge=off,hpet=off"
  "-no-user-config"
  "-nodefaults"
  "-global" "ICH9-LPC.disable_s3=1"
  "-global" "ICH9-LPC.noreboot=off"
  "-global" "kvm-pit.lost_tick_policy=discard"
  "-rtc" "base=utc,clock=host,driftfix=slew"
  "-device" "${VGA_DEVICE}"
  "-device" "nec-usb-xhci"
  "-device" "usb-tablet"
  "-audiodev" "none,id=audio1"
  "-vnc" "unix:/tmp/vnc/${VM_NAME}.sock,audiodev=audio1"
  "-device" "virtio-net-pci,netdev=net0,mac=${MAC_ADDR}"
  "-netdev" "tap,id=net0,ifname=${TAP_IF},script=no,downscript=no"
  "-device" "vmgenid,guid=${NOMAD_ALLOC_ID}"
  "-device" "virtio-scsi-pci,id=scsi0,num_queues=8"
  "-blockdev" "driver=file,filename=${JOB_DIR}/diff.${NOMAD_ALLOC_ID}.qcow2,node-name=disk0"
  "-blockdev" "driver=qcow2,file=disk0,node-name=image0"
  "-device" "scsi-hd,drive=image0,bus=scsi0.0"
)

# Add OpenStack compatible "config-2" drive for VM if "config-drive" folder exist.
# And generate meta_data.json if "user_data" is found.
# Look: https://github.com/hashicorp/nomad/issues/17970#issuecomment-2262899006
CONFIG_DIR="$TASK_DIR/local/config-drive"
if [ -d "$CONFIG_DIR" ]; then
  CLOUD_INIT_DIR="$CONFIG_DIR/openstack/latest"
  if [ -f "$CLOUD_INIT_DIR/user_data" ]; then
    echo "{\"uuid\": \"$NOMAD_ALLOC_ID\"}" > "$CLOUD_INIT_DIR/meta_data.json"
  fi

  genisoimage -input-charset utf-8 -volid config-2 -joliet -rock -o "${TASK_DIR}/config-drive.iso" $CONFIG_DIR
  QEMU_DEFAULT_ARGS+=("-drive" "file=${TASK_DIR}/config-drive.iso,media=cdrom,readonly=on")
fi

# Run QEMU
/usr/bin/qemu-system-x86_64 "${QEMU_DEFAULT_ARGS[@]}" "${EXTRA_ARGS[@]}" "${BOOT_TYPE_ARGS[@]}" &
CHILD=$!
wait "$CHILD"
